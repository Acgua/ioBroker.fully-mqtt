{
  "version": 3,
  "sources": ["../../src/lib/restApi.ts"],
  "sourcesContent": ["/**\r\n * REST API Class\r\n * Purpose: sending commands to Fully, since sending via MQTT is not supported by Fully.\r\n */\r\n\r\nimport axios from 'axios';\r\nimport { FullyMqtt } from '../main';\r\nimport { IDevice } from './interfaces';\r\n\r\n/**\r\n * @class RestApi\r\n * @desc  To send commands via REST API to Fully Browser\r\n */\r\nexport class RestApiFully {\r\n    /**\r\n     * Constants and Variables\r\n     */\r\n    private readonly adapter: FullyMqtt;\r\n\r\n    /**\r\n     * Class Constructor\r\n     * @param adapter - ioBroker adapter instance object\r\n     */\r\n    public constructor(adapter: FullyMqtt) {\r\n        this.adapter = adapter;\r\n    }\r\n\r\n    /**\r\n     * Get Info Object from Fully\r\n     * @param ip - IP Address\r\n     * @returns info object, or false in case of error\r\n     */\r\n    /* ----- NO LONGER USED since v0.1.0 ---\r\n    public async getInfo(ip: string): Promise<{ [k: string]: any } | false> {\r\n        try {\r\n            const device = this.adapter.fullys[ip];\r\n            const result = await this.axiosGetInfoOrSendCmd(device, 'getInfo');\r\n            if (result.status && result.infoObj !== undefined) {\r\n                return result.infoObj;\r\n            } else {\r\n                return false;\r\n            }\r\n        } catch (e) {\r\n            this.adapter.log.error(`[REST] ${this.adapter.fullys[ip].name}: ${this.adapter.err2Str(e)}`);\r\n            return false;\r\n        }\r\n    }\r\n    */\r\n\r\n    /**\r\n     * Send a command to Fully\r\n     * @param device - device object\r\n     * @param cmd - 'loadStartURL', 'screenOn', etc.\r\n     * @param val - state value\r\n     * @returns true if successful, false if not\r\n     */\r\n    public async sendCmd(device: IDevice, cmd: string, val: any): Promise<boolean> {\r\n        try {\r\n            interface ISendCmd {\r\n                urlParameter: string;\r\n                cleanSpaces?: true;\r\n                encode?: true;\r\n            }\r\n            const cmds: { [k: string]: ISendCmd } = {\r\n                textToSpeech: { urlParameter: 'cmd=textToSpeech&text=', cleanSpaces: true, encode: true },\r\n                loadURL: { urlParameter: 'cmd=loadURL&url=', cleanSpaces: true, encode: true },\r\n                startApplication: { urlParameter: 'cmd=startApplication&package=', cleanSpaces: true },\r\n                screenBrightness: { urlParameter: 'cmd=setStringSetting&key=screenBrightness&value=' },\r\n                setAudioVolume: { urlParameter: 'cmd=setAudioVolume&stream=3&level=' },\r\n            };\r\n            let finalUrlParam = '';\r\n            if (cmd in cmds) {\r\n                if (cmds[cmd].cleanSpaces) {\r\n                    val = val.toString().trim();\r\n                    val = val.replace(/\\s+/g, ' ');\r\n                }\r\n                if (cmds[cmd].encode) {\r\n                    val = val.toString().trim();\r\n                    val = encodeURIComponent(val);\r\n                }\r\n                finalUrlParam = cmds[cmd].urlParameter + val;\r\n            } else {\r\n                finalUrlParam = 'cmd=' + cmd;\r\n            }\r\n\r\n            const result = await this.axiosGetInfoOrSendCmd(device, 'sendCmd', cmd, finalUrlParam);\r\n            return result.status;\r\n        } catch (e) {\r\n            this.adapter.log.error(`[REST] ${device.name}: ${this.adapter.err2Str(e)}`);\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Axios: Get Device Info or Send Command\r\n     * @param device - device object\r\n     * @param what - 'getInfo' to get device info or 'sendCmd' to send a command\r\n     * @param cmd - if 'sendCmd': Command like \"screenOff\"\r\n     * @param urlParam - if 'sendCmd': URL parameter like \"cmd=screenOff\"\r\n     * @returns if what='getInfo': false if error, device info object if true\r\n     *          if what='sendCmd': false if error, true if successful\r\n     *\r\n     * TODO: Remove 'getInfo' since no longer used from version 0.1.0\r\n     *\r\n     */\r\n    private async axiosGetInfoOrSendCmd(device: IDevice, what: 'getInfo' | 'sendCmd', cmd?: string, urlParam?: string): Promise<{ status: true | false; infoObj?: { [k: string]: any } }> {\r\n        // Base URL\r\n        const baseUrl = `${device.restProtocol}://${device.ip}:${device.restPort}/?password=${this.encodePassword(device.restPassword)}&type=json`;\r\n        let finalUrl = '';\r\n        if (what === 'getInfo') {\r\n            finalUrl = baseUrl + '&cmd=deviceInfo';\r\n        } else {\r\n            finalUrl = baseUrl + '&' + urlParam;\r\n        }\r\n\r\n        // Axios config\r\n        const config = {\r\n            method: 'get',\r\n            timeout: this.adapter.config.restTimeout,\r\n        };\r\n\r\n        try {\r\n            // Log\r\n            let urlHiddenPassword = finalUrl;\r\n            urlHiddenPassword = urlHiddenPassword.replace(/password=.*&type/g, 'password=(hidden)&type');\r\n            this.adapter.log.debug(`[REST] ${device.name}: Start ${what} ${what === 'sendCmd' ? '\"' + cmd + '\"' : ''}, URL: ${urlHiddenPassword}`);\r\n\r\n            // Axios: Send command\r\n            const response = await axios.get(finalUrl, config);\r\n\r\n            // Errors\r\n            if (response.status !== 200) {\r\n                this.adapter.log.error(`[REST] ${device.name}: ${what} ${what === 'sendCmd' ? cmd : ''} failed: ${response.status} - ${response.statusText}`);\r\n                this.adapter.onAliveChange('REST', device.ip, false, '${response.status} - ${response.statusText}'); // Update isAlive\r\n                return { status: false };\r\n            }\r\n            if (!('status' in response)) {\r\n                this.adapter.log.error(`[REST] ${device.name}: ${what} ${what === 'sendCmd' ? cmd : ''} failed: Response received but it does not have key 'status'`);\r\n                this.adapter.onAliveChange('REST', device.ip, false, 'response without status key'); // Update isAlive\r\n                return { status: false };\r\n            }\r\n            if (!('data' in response)) {\r\n                this.adapter.log.error(`[REST] ${device.name}: ${what} ${what === 'sendCmd' ? cmd : ''} failed: Response received but it does not have key 'data'`);\r\n                this.adapter.onAliveChange('REST', device.ip, false, 'response without data key'); // Update isAlive\r\n                return { status: false };\r\n            }\r\n            this.adapter.log.debug(`[REST] ${device.name}: ${what} response.data: ${JSON.stringify(response.data)}`);\r\n\r\n            // Handle Device Info\r\n            if (what === 'getInfo') {\r\n                this.adapter.onAliveChange('REST', device.ip, true, 'information successfully received'); // Update isAlive\r\n                if (!('deviceName' in response.data)) {\r\n                    // we check if info object is ok by checking for deviceName, could also use any other key like screenOn etc.\r\n                    this.adapter.log.error(`[REST] ${device.name}: getInfo failed: Response data received, but data does not have key 'deviceName'`);\r\n                    return { status: false };\r\n                }\r\n                this.adapter.log.debug(`[REST] ${device.name}: getInfo was successful: Response = ${response.status} - ${response.statusText}`);\r\n                return { status: true, infoObj: response.data };\r\n            }\r\n\r\n            // Handle all other commands\r\n            if (!('status' in response.data)) {\r\n                this.adapter.onAliveChange('REST', device.ip, false, 'response.data without status key'); // Update isAlive\r\n                this.adapter.log.error(`[REST] ${device.name}: Sending ${what} failed: Response received but response.data does not have key 'status'`);\r\n                return { status: false };\r\n            }\r\n            switch (response.data.status) {\r\n                case 'OK':\r\n                    this.adapter.log.debug(`[REST] ${device.name}: Sending ${what} successful: - Status = \"${response.data.status}\", Message = \"${response.data.statustext}\"`);\r\n                    this.adapter.onAliveChange('REST', device.ip, true, 'successfully received response'); // Update isAlive\r\n                    return { status: true };\r\n                case 'Error':\r\n                    if (response.data.statustext === 'Please login') {\r\n                        this.adapter.log.error(`[REST] ${device.name}: Error: Remote Admin Password seems to be incorrect. Sending ${what} failed.`);\r\n                        this.adapter.onAliveChange('REST', device.ip, false, 'incorrect Remote Admin password'); // Update isAlive\r\n                    } else {\r\n                        this.adapter.log.error(`[REST] ${device.name}: Error: Sending cmd ${what} failed, received status text: ${response.data.statustext}`);\r\n                        this.adapter.onAliveChange('REST', device.ip, false, `sending cmd ${what} failed`); // Update isAlive\r\n                    }\r\n                    return { status: false };\r\n                default:\r\n                    // Unexpected\r\n                    this.adapter.log.error(`[REST] ${device.name}: Undefined response.data.status = \"${response.data.status}\" when sending cmd ${what}: ${response.status} - ${response.statusText}`);\r\n                    this.adapter.onAliveChange('REST', device.ip, false, 'received undefined response.data.status');\r\n                    return { status: false };\r\n            }\r\n        } catch (err) {\r\n            const errTxt = `[REST] ${device.name}: Sending ${what} failed`;\r\n            this.adapter.onAliveChange('REST', device.ip, false, `sending ${what} failed`); // Update isAlive\r\n            if (axios.isAxiosError(err)) {\r\n                if (!err?.response) {\r\n                    this.adapter.log.warn(`${errTxt}: No response`);\r\n                } else if (err.response?.status === 400) {\r\n                    this.adapter.log.error('${errTxt}: Login Failed - Error 400 - ' + err.response?.statusText);\r\n                } else if (err.response?.status) {\r\n                    this.adapter.log.error(`${errTxt}: ${err.response.status} - ${err.response.statusText}`);\r\n                } else {\r\n                    this.adapter.log.error(`${errTxt}: General Error`);\r\n                }\r\n            } else {\r\n                this.adapter.log.error(`[REST] ${device.name} Error: ${this.adapter.err2Str(err)}`);\r\n            }\r\n            return { status: false };\r\n        }\r\n    }\r\n\r\n    /**\r\n     * To encode a password to be sent to web server\r\n     * Source: fixedEncodeURIComponent() from https://github.com/arteck/ioBroker.fullybrowser/blob/master/main.js\r\n     * @param pw Password\r\n     * @returns Encoded password\r\n     */\r\n    private encodePassword(pw: string): string {\r\n        return encodeURIComponent(pw).replace(/[!'()*]/g, (c) => `%${c.charCodeAt(0).toString(16).toUpperCase()}`);\r\n    }\r\n}\r\n"],
  "mappings": "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",
  "names": ["axios"]
}
