{
  "version": 3,
  "sources": ["../../src/lib/restApi.ts"],
  "sourcesContent": ["/**\n * REST API Class\n * Purpose: sending commands to Fully, since sending via MQTT is not supported by Fully.\n */\n\nimport axios from 'axios';\nimport { FullyMqtt } from '../main';\nimport { IDevice } from './interfaces';\n\n/**\n * @class RestApi\n * @desc  To send commands via REST API to Fully Browser\n */\nexport class RestApiFully {\n    /**\n     * Constants and Variables\n     */\n    private readonly adapter: FullyMqtt;\n\n    /**\n     * Class Constructor\n     * @param adapter - ioBroker adapter instance object\n     */\n    public constructor(adapter: FullyMqtt) {\n        this.adapter = adapter;\n    }\n\n    /**\n     * Send a command to Fully\n     * @param device - device object\n     * @param cmd - 'loadStartURL', 'screenOn', etc.\n     * @param val - state value\n     * @returns true if successful, false if not\n     */\n    public async sendCmd(device: IDevice, cmd: string, val: any): Promise<boolean> {\n        try {\n            interface ISendCmd {\n                urlParameter: string;\n                cleanSpaces?: true;\n                encode?: true;\n            }\n            const cmds: { [k: string]: ISendCmd } = {\n                textToSpeech: { urlParameter: 'cmd=textToSpeech&text=', cleanSpaces: true, encode: true },\n                loadURL: { urlParameter: 'cmd=loadURL&url=', cleanSpaces: true, encode: true },\n                startApplication: { urlParameter: 'cmd=startApplication&package=', cleanSpaces: true },\n                screenBrightness: { urlParameter: 'cmd=setStringSetting&key=screenBrightness&value=' },\n                setAudioVolume: { urlParameter: 'cmd=setAudioVolume&stream=3&level=' },\n            };\n            let finalUrlParam = '';\n            if (cmd in cmds) {\n                if (cmds[cmd].cleanSpaces) {\n                    val = val.toString().trim();\n                    val = val.replace(/\\s+/g, ' ');\n                }\n                if (cmds[cmd].encode) {\n                    val = val.toString().trim();\n                    val = encodeURIComponent(val);\n                }\n                finalUrlParam = cmds[cmd].urlParameter + val;\n            } else {\n                finalUrlParam = 'cmd=' + cmd;\n            }\n\n            const result = await this.axiosSendCmd(device, cmd, finalUrlParam);\n            return result;\n        } catch (e) {\n            this.adapter.log.error(`[REST] ${device.name}: ${this.adapter.err2Str(e)}`);\n            return false;\n        }\n    }\n\n    /**\n     * Axios: Send Command\n     * @param device - device object\n     * @param cmd - Command like \"screenOff\"\n     * @param urlParam - URL parameter like \"cmd=screenOff\"\n     * @returns false if error, true if successful\n     */\n    private async axiosSendCmd(device: IDevice, cmd: string, urlParam: string): Promise<true | false> {\n        // Base URL\n        const url = `${device.restProtocol}://${device.ip}:${device.restPort}/?password=${this.encodePassword(device.restPassword)}&type=json&${urlParam}`;\n\n        // Axios config\n        const config = {\n            method: 'get',\n            timeout: this.adapter.config.restTimeout,\n        };\n\n        try {\n            // Log\n            let urlHiddenPassword = url;\n            urlHiddenPassword = urlHiddenPassword.replace(/password=.*&type/g, 'password=(hidden)&type');\n            this.adapter.log.debug(`[REST] ${device.name}: Start sending command ${cmd}, URL: ${urlHiddenPassword}`);\n\n            // Axios: Send command\n            const response = await axios.get(url, config);\n\n            // Errors\n            if (response.status !== 200) {\n                this.adapter.log.error(`[REST] ${device.name}: Sending command ${cmd} failed: ${response.status} - ${response.statusText}`);\n                return false;\n            }\n            if (!('status' in response)) {\n                this.adapter.log.error(`[REST] ${device.name}: Sending command ${cmd} failed: Response received but it does not have key 'status'`);\n                return false;\n            }\n            if (!('data' in response)) {\n                this.adapter.log.error(`[REST] ${device.name}: Sending command ${cmd} failed: Response received but it does not have key 'data'`);\n                return false;\n            }\n            this.adapter.log.debug(`[REST] ${device.name}: Sending command ${cmd} response.data: ${JSON.stringify(response.data)}`);\n\n            if (!('status' in response.data)) {\n                this.adapter.log.error(`[REST] ${device.name}: Sending command ${cmd} failed: Response received but response.data does not have key 'status'`);\n                return false;\n            }\n            switch (response.data.status) {\n                case 'OK':\n                    this.adapter.log.debug(`[REST] ${device.name}: Sending command ${cmd} successful: - Status = \"${response.data.status}\", Message = \"${response.data.statustext}\"`);\n                    return true;\n                case 'Error':\n                    if (response.data.statustext === 'Please login') {\n                        this.adapter.log.error(`[REST] ${device.name}: Error: Remote Admin Password seems to be incorrect. Sending command ${cmd} failed.`);\n                    } else {\n                        this.adapter.log.error(`[REST] ${device.name}: Error: Sending command ${cmd} failed, received status text: ${response.data.statustext}`);\n                    }\n                    return false;\n                default:\n                    // Unexpected\n                    this.adapter.log.error(`[REST] ${device.name}: Undefined response.data.status = \"${response.data.status}\" when sending command ${cmd}: ${response.status} - ${response.statusText}`);\n                    return false;\n            }\n        } catch (err) {\n            const errTxt = `[REST] ${device.name}: Sending command ${cmd} failed`;\n            if (axios.isAxiosError(err)) {\n                if (!err?.response) {\n                    this.adapter.log.warn(`${errTxt}: No response`);\n                } else if (err.response?.status === 400) {\n                    this.adapter.log.error('${errTxt}: Login Failed - Error 400 - ' + err.response?.statusText);\n                } else if (err.response?.status) {\n                    this.adapter.log.error(`${errTxt}: ${err.response.status} - ${err.response.statusText}`);\n                } else {\n                    this.adapter.log.error(`${errTxt}: General Error`);\n                }\n            } else {\n                this.adapter.log.error(`${errTxt}: Error: ${this.adapter.err2Str(err)}`);\n            }\n            return false;\n        }\n    }\n\n    /**\n     * To encode a password to be sent to web server\n     * Source: fixedEncodeURIComponent() from https://github.com/arteck/ioBroker.fullybrowser/blob/master/main.js\n     * @param pw Password\n     * @returns Encoded password\n     */\n    private encodePassword(pw: string): string {\n        return encodeURIComponent(pw).replace(/[!'()*]/g, (c) => `%${c.charCodeAt(0).toString(16).toUpperCase()}`);\n    }\n}\n"],
  "mappings": "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",
  "names": ["axios"]
}
