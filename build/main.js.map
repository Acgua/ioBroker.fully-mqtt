{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/**\n * -------------------------------------------------------------------\n * ioBroker Fully Browser MQTT Adapter\n * @github  https://github.com/Acgua/ioBroker.fully-mqtt\n * @forum   https://forum.iobroker.net/topic/63705/\n * @author  Acgua <https://github.com/Acgua/ioBroker.fully-mqtt>\n * @license Apache License 2.0\n * -------------------------------------------------------------------\n */\n\n/**\n * For all imported NPM modules, open console, change dir for example to \"C:\\iobroker\\node_modules\\ioBroker.fully-mqtt\\\"\n * and execute \"npm install <module name>\", e.g., npm install axios\n */\nimport * as utils from '@iobroker/adapter-core';\nimport { CONST } from './lib/constants';\nimport { ICmds, IDevice } from './lib/interfaces';\nimport { cleanDeviceName, err2Str, getConfigValuePerKey, isEmpty, isIpAddressValid, wait } from './lib/methods';\nimport { MqttServer } from './lib/mqtt-server';\nimport { RestApiFully } from './lib/restApi';\n\n/**\n * Main ioBroker Adapter Class\n */\nexport class FullyMqtt extends utils.Adapter {\n    // Imported methods from ./lib/methods\n    public err2Str = err2Str.bind(this);\n    public isEmpty = isEmpty.bind(this);\n    public wait = wait.bind(this);\n    public cleanDeviceName = cleanDeviceName.bind(this);\n    public getConfigValuePerKey = getConfigValuePerKey.bind(this);\n    public isIpAddressValid = isIpAddressValid.bind(this);\n    // MQTT\n    private mqtt_Server: MqttServer | undefined;\n    public mqtt_useMqtt: true | false = false; // Is use of MQTT activated per adapter settings (each line of fully devices is checked)\n\n    // REST API\n    private restApi_inst = new RestApiFully(this); // RestApi Class Instance\n\n    /**\n     * Active Fullys: IP as key, and object per IDevice\n     * {\n     *    '192.168.10.20': {name: 'Tablet Kitchen', id:'Tablet-Kitchen', ip:'192.168.10.20', ...},\n     *    '192.168.10.30': {name: 'Tablet Hallway', id:'Tablet-Hallway', ip:'192.168.10.30', ...},\n     * }\n     * Use this.getFullyPerKey() to get fully object per provided key\n     */\n    public fullys: { [ip: string]: IDevice } = {};\n\n    // array of device ids, which are not activated\n    public disabledDeviceIds = [] as string[];\n    // All active IP addresses\n    public activeDeviceIPs = [] as string[];\n\n    // Has onAliveChange() ever been called before?\n    private onAliveChange_EverBeenCalledBefore = false;\n\n    /**\n     * Constructor\n     */\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\n        super({ ...options, name: 'fully-mqtt' });\n\n        this.on('ready', this.iob_onReady.bind(this));\n        this.on('stateChange', this.iob_onStateChange.bind(this));\n        // this.on('objectChange', this.onObjectChange.bind(this));\n        // this.on('message', this.onMessage.bind(this));\n        this.on('unload', this.iob_onUnload.bind(this));\n    }\n\n    /**\n     * Is called when databases are connected and adapter received configuration.\n     */\n    private async iob_onReady(): Promise<void> {\n        try {\n            /**\n             * Set the connection indicator to false during startup\n             */\n            this.setState('info.connection', { val: false, ack: true });\n\n            /**\n             * Init configuration\n             */\n            if (await this.initConfig()) {\n                this.log.debug(`Adapter settings successfully verified and initialized.`);\n            } else {\n                this.log.error(`Adapter settings initialization failed.  ---> Please check your adapter instance settings!`);\n                return;\n            }\n\n            /**\n             * Start MQTT Server\n             */\n            if (this.mqtt_useMqtt) {\n                this.mqtt_Server = new MqttServer(this);\n                this.mqtt_Server.start();\n            }\n\n            /**\n             * Call main() for each device\n             */\n            for (const ip in this.fullys) {\n                await this.main(this.fullys[ip]);\n            }\n\n            /**\n             * Remove device objects if device was renamed\n             */\n            // Get string array of all adapter objects: ['fully-mqtt.0.info', 'fully-mqtt.0.info.connection', ...];\n            const paths = Object.keys(await this.getAdapterObjectsAsync());\n\n            // Ignore fully-mqtt.0.info tree (which includes fully-mqtt.0.info.connection, ...)\n            const idBlacklist = ['info'];\n\n            // Get fully device ids of 'fully-mqtt.0.Kitchen' etc., like ['Kitchen', 'Tablet-Bathroom', ...]\n            const allDeviceIds: Array<string> = [];\n            for (const path of paths) {\n                const pathSplit = path.split('.');\n                if (idBlacklist.includes(pathSplit[2])) {\n                    //this.log.debug(`Ignore ${path} since it should not be removed!`);\n                } else {\n                    const id = pathSplit[2]; // e.g. 'Kitchen'\n                    if (!allDeviceIds.includes(id)) allDeviceIds.push(id);\n                }\n            }\n            // process all device ids\n            for (const id of allDeviceIds) {\n                // We consider both enabled and disabled devices and only remove states if device row was deleted in config\n                const enabledAndDisabled = this.disabledDeviceIds;\n                for (const ip in this.fullys) {\n                    enabledAndDisabled.push(this.fullys[ip].id);\n                }\n\n                if (!enabledAndDisabled.includes(id)) {\n                    await this.delObjectAsync(id, { recursive: true });\n                    this.log.info(`Cleanup: Deleted no longer defined objects of '${id}'.`);\n                }\n            }\n        } catch (e) {\n            this.log.error(this.err2Str(e));\n            return;\n        }\n    }\n\n    /**\n     * main function for each Fully Browser Device\n     * @param device Fully Browser Device Object\n     */\n    private async main(device: IDevice): Promise<void> {\n        try {\n            this.log.debug(`Start main() - ${device.name} (${device.ip})\u2026`);\n\n            /**\n             * Create device object(s)\n             */\n            // Device and Info object\n            await this.setObjectNotExistsAsync(device.id, {\n                type: 'device',\n                common: {\n                    name: device.name,\n                    //@ts-expect-error - Object \"statusStates\" is needed for status, error is: Object literal may only specify known properties, and 'statusStates' does not exist in type 'DeviceCommon'.ts(2345)\n                    statusStates: { onlineId: `${this.namespace}.${device.id}.alive` },\n                },\n                native: {},\n            });\n            await this.setObjectNotExistsAsync(device.id + '.Info', { type: 'channel', common: { name: 'Device Information' }, native: {} });\n\n            // Alive and info update\n            await this.setObjectNotExistsAsync(device.id + '.alive', {\n                type: 'state',\n                common: {\n                    name: 'Is Fully alive?',\n                    desc: 'If Fully Browser is alive or not',\n                    type: 'boolean',\n                    role: 'indicator.reachable',\n                    icon: 'data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iTXVpU3ZnSWNvbi1yb290IE11aVN2Z0ljb24tZm9udFNpemVNZWRpdW0gaWNvbk93biBjc3MtdnViYnV2IiBmb2N1c2FibGU9ImZhbHNlIiBhcmlhLWhpZGRlbj0idHJ1ZSIgdmlld0JveD0iMCAwIDI0IDI0IiBkYXRhLXRlc3RpZD0iV2lmaUljb24iPjxwYXRoIGQ9Im0xIDkgMiAyYzQuOTctNC45NyAxMy4wMy00Ljk3IDE4IDBsMi0yQzE2LjkzIDIuOTMgNy4wOCAyLjkzIDEgOXptOCA4IDMgMyAzLTNjLTEuNjUtMS42Ni00LjM0LTEuNjYtNiAwem0tNC00IDIgMmMyLjc2LTIuNzYgNy4yNC0yLjc2IDEwIDBsMi0yQzE1LjE0IDkuMTQgOC44NyA5LjE0IDUgMTN6Ij48L3BhdGg+PC9zdmc+',\n                    read: true,\n                    write: false,\n                },\n                native: {},\n            });\n            await this.setObjectNotExistsAsync(device.id + '.lastInfoUpdate', { type: 'state', common: { name: 'Last information update', desc: 'Date/time of last information update from Fully Browser', type: 'number', role: 'value.time', read: true, write: false }, native: {} });\n            await this.setObjectNotExistsAsync(device.id + '.mqttActivated', { type: 'state', common: { name: 'Is MQTT activated?', desc: 'If MQTT is activated for at least one Fully Browser in adapter options', type: 'boolean', role: 'indicator', read: true, write: false }, native: {} });\n\n            // REST API Commands Objects\n            await this.setObjectNotExistsAsync(device.id + '.Commands', { type: 'channel', common: { name: 'Commands (REST API)' }, native: {} });\n            const allCommands = CONST.cmds.concat(CONST.cmdsSwitches); // join both arrays\n            for (const cmdObj of allCommands) {\n                let lpRole = '';\n                if (cmdObj.type === 'boolean') lpRole = 'button';\n                if (cmdObj.type === 'string') lpRole = 'text';\n                if (cmdObj.type === 'number') lpRole = 'value';\n                if (cmdObj.cmdOn && cmdObj.cmdOff) lpRole = 'switch';\n                await this.setObjectNotExistsAsync(device.id + '.Commands.' + cmdObj.id, { type: 'state', common: { name: 'Command: ' + cmdObj.name, type: cmdObj.type, role: lpRole, read: true, write: true }, native: {} });\n            }\n            // REST API Create and update Info Objects\n            if (!device.useMQTT) {\n                const infoObj = await this.restApi_inst.getInfo(device.ip);\n                if (!infoObj) return;\n                await this.createInfoObjects('restApi', infoObj, device.ip);\n                // REST API set info states now\n                await this.setInfoStates('REST', infoObj, device.ip);\n            }\n\n            // Create MQTT Events Objects\n            // More states are created once a new Event is received!\n            if (device.useMQTT) {\n                await this.setObjectNotExistsAsync(device.id + '.Events', { type: 'channel', common: { name: 'MQTT Events' }, native: {} });\n                for (const event of CONST.mqttEvents) {\n                    await this.setObjectNotExistsAsync(device.id + '.Events.' + event, { type: 'state', common: { name: 'MQTT Event: ' + event, type: 'boolean', role: 'switch', read: true, write: false }, native: {} });\n                }\n            }\n\n            // Update MQTT Activated state\n            this.setState(device.id + '.mqttActivated', { val: device.useMQTT, ack: true });\n\n            /**\n             * REST API: Subscribe to state changes\n             */\n            await this.subscribeStatesAsync(device.id + '.Commands.*');\n\n            /**\n             * REST API: INFO: Update and Schedule Update\n             */\n            if (!device.useMQTT) {\n                // Schedule regular update\n                await this.scheduleRestApiRequestInfo(device.ip);\n                this.log.info(`[REST] ${device.name}: Regular info update requests scheduled (every ${this.config.restInterval} seconds).`);\n            }\n        } catch (e) {\n            this.log.error(this.err2Str(e));\n            return;\n        }\n    }\n\n    /**\n     * Create Info Objects either for MQTT or for REST API\n     * @param source mqtt or restApi\n     * @param device device object\n     * @returns true if successful, false if not\n     */\n    private async createInfoObjects(source: 'mqtt' | 'restApi', infoObj: { [k: string]: any }, ip: string): Promise<void> {\n        try {\n            const device = this.fullys[ip];\n            for (const key in infoObj) {\n                const val = infoObj[key];\n                const valType = typeof val;\n                if (valType === 'string' || valType === 'boolean' || valType === 'object' || valType === 'number') {\n                    if (source === 'mqtt') {\n                        // MQTT\n                        this.fullys[ip].mqttInfoKeys.push(key);\n                    } else {\n                        // REST API\n                        this.fullys[ip].restInfoKeys.push(key);\n                    }\n                    await this.setObjectNotExistsAsync(`${device.id}.Info.${key}`, { type: 'state', common: { name: 'Info: ' + key, type: valType, role: 'value', read: true, write: false }, native: {} });\n                } else {\n                    this.log.warn(`Unknown type ${valType} of key '${key}' in info object`);\n                    continue;\n                }\n            }\n        } catch (e) {\n            this.log.error(this.err2Str(e));\n            return;\n        }\n    }\n\n    /**\n     * Update Info States - MQTT or REST API\n     * @param ip IP Address\n     * @returns void\n     */\n    private async setInfoStates(source: 'MQTT' | 'REST', infoObj: { [k: string]: any }, ip: string): Promise<void> {\n        try {\n            for (const key in infoObj) {\n                let isKeyUnknown = true;\n                let updateUnchanged = false;\n                if (source === 'MQTT') {\n                    if (this.fullys[ip].mqttInfoKeys.includes(key)) isKeyUnknown = false;\n                    if (this.config.mqttUpdateUnchangedObjects) updateUnchanged = true;\n                } else if (source === 'REST') {\n                    if (this.fullys[ip].restInfoKeys.includes(key)) isKeyUnknown = false;\n                    if (this.config.restUpdateUnchangedObjects) updateUnchanged = true;\n                }\n                if (isKeyUnknown) {\n                    this.log.debug(`${this.fullys[ip].name}: Yet unknown key '${key}' in info object of ${source}, so create state`);\n                    this.createInfoObjects('mqtt', { [key]: infoObj[key] }, ip);\n                }\n                const newVal = typeof infoObj[key] === 'object' ? JSON.stringify(infoObj[key]) : infoObj[key]; // https://forum.iobroker.net/post/628870 - https://forum.iobroker.net/post/960260\n                if (updateUnchanged) {\n                    this.setState(`${this.fullys[ip].id}.Info.${key}`, { val: newVal, ack: true });\n                } else {\n                    this.setStateChanged(`${this.fullys[ip].id}.Info.${key}`, { val: newVal, ack: true });\n                }\n            }\n            this.setState(this.fullys[ip].id + '.lastInfoUpdate', { val: Date.now(), ack: true });\n            this.setState(this.fullys[ip].id + '.alive', { val: true, ack: true });\n        } catch (e) {\n            this.log.error(this.err2Str(e));\n            return;\n        }\n    }\n\n    /**\n     * Schedule: REST API get info through timeout\n     * @param ip IP Address\n     * @returns void\n     */\n    private async scheduleRestApiRequestInfo(ip: string): Promise<void> {\n        try {\n            // @ts-expect-error \"Type 'null' is not assignable to type 'Timeout'.ts(2345)\" - we check for not being null via \"if\"\n            if (this.fullys[ip].timeoutRestRequestInfo) this.clearTimeout(this.fullys[ip].timeoutRestRequestInfo);\n            const interval = this.config.restInterval * 1000;\n            if (interval < 2000) throw `[REST] We do not allow to set a REST API interval for info update every < 2 seconds!`;\n            this.fullys[ip].timeoutRestRequestInfo = this.setTimeout(async () => {\n                try {\n                    // Update Info\n                    const infoObj = await this.restApi_inst.getInfo(ip);\n                    if (infoObj !== false) {\n                        // Successful (no error)\n                        // Set states\n                        await this.setInfoStates('REST', infoObj, ip);\n                        // Call this function again since we are in callback of timeout\n                    } else {\n                        // error, was handled before in calling function\n                    }\n                    this.scheduleRestApiRequestInfo(ip);\n                } catch (e) {\n                    this.log.error(this.err2Str(e));\n                    return;\n                }\n            }, interval);\n        } catch (e) {\n            this.log.error(this.err2Str(e));\n            return;\n        }\n    }\n\n    /**\n     * Verify adapter instance settings\n     */\n    private async initConfig(): Promise<true | false> {\n        try {\n            /*************************\n             * REST API Fields\n             *************************/\n            if (this.isEmpty(this.config.restTimeout) || this.config.restTimeout < 500 || this.config.restTimeout > 15000) {\n                this.log.warn(`Adapter instance settings: REST API timeout of ${this.config.restTimeout} ms is not allowed, set to default of 6000ms`);\n                this.config.restTimeout = 6000;\n            }\n            if (this.isEmpty(this.config.restInterval) || this.config.restInterval < 5 || this.config.restInterval > 86400000) {\n                this.log.warn(`Adapter instance settings: REST API interval of ${this.config.restInterval}s is not allowed, set to default of 60s`);\n                this.config.restInterval = 60;\n            }\n\n            /*************************\n             * MQTT Fields\n             *************************/\n            if (this.isEmpty(this.config.mqttPort) || this.config.mqttPort < 1 || this.config.mqttPort > 65535) {\n                this.log.warn(`Adapter instance settings: MQTT Port ${this.config.mqttPort} is not allowed, set to default of 1886`);\n                this.config.mqttPort = 1886;\n            }\n            if (this.isEmpty(this.config.mqttPublishedInfoDelay) || this.config.mqttPublishedInfoDelay < 2 || this.config.mqttPublishedInfoDelay > 120) {\n                this.log.warn(`Adapter instance settings: MQTT Publish Info Delay of ${this.config.mqttPublishedInfoDelay}s is not allowed, set to default of 30s`);\n                this.config.mqttPublishedInfoDelay = 30;\n            }\n\n            /*************************\n             * Table Devices\n             *************************/\n            if (this.isEmpty(this.config.tableDevices)) {\n                this.log.error(`No Fully devices defined in adapter instance settings!`);\n                return false;\n            }\n            const deviceIds: string[] = []; // to check for duplicate device ids\n            for (let i = 0; i < this.config.tableDevices.length; i++) {\n                const lpDevice = this.config.tableDevices[i];\n                const finalDevice: IDevice = {\n                    name: '',\n                    id: '',\n                    ip: '',\n                    mqttClientId: undefined,\n                    useMQTT: false,\n                    restProtocol: 'http',\n                    restPort: 0,\n                    restPassword: '',\n                    lastSeen: 0, // timestamp\n                    isAlive: false,\n                    timeoutRestRequestInfo: null,\n                    mqttInfoObjectsCreated: false,\n                    mqttInfoKeys: [],\n                    restInfoKeys: [],\n                };\n\n                // name\n                if (this.isEmpty(lpDevice.name)) {\n                    this.log.error(`Provided device name \"${lpDevice.name}\" is empty!`);\n                    return false;\n                }\n                finalDevice.name = lpDevice.name.trim();\n\n                // id\n                finalDevice.id = this.cleanDeviceName(lpDevice.name);\n                if (finalDevice.id.length < 1) {\n                    this.log.error(`Provided device name \"${lpDevice.name}\" is too short and/or has invalid characters!`);\n                    return false;\n                }\n                if (deviceIds.includes(finalDevice.id)) {\n                    this.log.error(`Device \"${finalDevice.name}\" -> id:\"${finalDevice.id}\" is used for more than once device.`);\n                    return false;\n                } else {\n                    deviceIds.push(finalDevice.id);\n                }\n\n                // REST Protocol (http/https)\n                if (lpDevice.restProtocol !== 'http' && lpDevice.restProtocol !== 'https') {\n                    this.log.warn(`${finalDevice.name}: REST API Protocol is empty, set to http as default.`);\n                    finalDevice.restProtocol = 'http';\n                } else {\n                    finalDevice.restProtocol = lpDevice.restProtocol;\n                }\n\n                // Use MQTT\n                if (lpDevice.useMQTT) {\n                    finalDevice.useMQTT = true;\n                } else {\n                    finalDevice.useMQTT = false;\n                }\n\n                // IP Address\n                if (!this.isIpAddressValid(lpDevice.ip)) {\n                    this.log.error(`${finalDevice.name}: Provided IP address \"${lpDevice.ip}\" is not valid!`);\n                    return false;\n                } else {\n                    finalDevice.ip = lpDevice.ip;\n                    // global array for all active IPs\n                    if (lpDevice.isActive) {\n                        this.activeDeviceIPs.push(lpDevice.ip);\n                    }\n                }\n                // REST Port\n                if (isNaN(lpDevice.restPort) || lpDevice.restPort < 0 || lpDevice.restPort > 65535) {\n                    this.log.error(`Adapter config Fully port number ${lpDevice.restPort} is not valid, should be >= 0 and < 65536.`);\n                    return false;\n                } else {\n                    finalDevice.restPort = Math.round(lpDevice.restPort);\n                }\n                // REST Password\n                if (isEmpty(lpDevice.restPassword)) {\n                    this.log.error(`Remote Admin (REST API) Password must not be empty!`);\n                    return false;\n                } else {\n                    finalDevice.restPassword = lpDevice.restPassword;\n                }\n\n                this.log.debug(`Final Config: ${JSON.stringify(finalDevice)}`);\n                if (lpDevice.isActive) {\n                    // Is Active\n\n                    // if MQTT is activated, set variable to true\n                    if (lpDevice.useMQTT) {\n                        this.mqtt_useMqtt = true;\n                        this.log.info(`${finalDevice.name} (${finalDevice.ip}) MQTT is activated in adapter instance settings.`);\n                    } else {\n                        this.log.info(`${finalDevice.name} (${finalDevice.ip}) MQTT is not activated in adapter instance settings.`);\n                    }\n\n                    // Finalize\n                    this.fullys[finalDevice.ip] = finalDevice;\n                    this.log.info(`\uD83D\uDDF8 ${finalDevice.name} (${finalDevice.ip}): Config successfully verified.`);\n                } else {\n                    // Skip if not active. (but we did verification anyway!)\n                    this.disabledDeviceIds.push(finalDevice.id);\n                    this.log.debug(`Device ${finalDevice.name} (${finalDevice.ip}) is not enabled, so skip it.`);\n                    continue;\n                }\n            }\n\n            if (this.activeDeviceIPs.length == 0) {\n                this.log.error(`No active devices with correct configuration found.`);\n                return false;\n            }\n            return true;\n        } catch (e) {\n            this.log.error(this.err2Str(e));\n            return false;\n        }\n    }\n\n    /**\n     * On Alive Changes\n     * for both REST API and MQTT\n     */\n    public async onAliveChange(source: 'MQTT' | 'REST', ip: string, isAlive: true | false): Promise<void> {\n        try {\n            const prevIsAlive = this.fullys[ip].isAlive;\n            this.fullys[ip].isAlive = isAlive;\n\n            // Has this function ever been called before? If adapter is restarted, we ensure log, etc.\n            const calledBefore = this.onAliveChange_EverBeenCalledBefore; // Keep old value\n            this.onAliveChange_EverBeenCalledBefore = true; // Now it was called\n\n            /***********\n             * 1 - Fully Device\n             ***********/\n            // if alive status changed\n            if ((!calledBefore && isAlive === true) || prevIsAlive !== isAlive) {\n                // Set Device isAlive Status - we could also use setStateChanged()...\n                this.setState(this.fullys[ip].id + '.alive', { val: isAlive, ack: true });\n\n                // log\n                if (isAlive) {\n                    this.log.info(`[${source}] ${this.fullys[ip].name} is alive.`);\n                } else {\n                    this.log.warn(`[${source}] ${this.fullys[ip].name} is not alive!`);\n                }\n            } else {\n                // No change\n            }\n\n            /***********\n             * 2 - Adapter Connection indicator\n             ***********/\n            let countAll = 0;\n            let countAlive = 0;\n            for (const lpIpAddr in this.fullys) {\n                countAll++;\n                if (this.fullys[lpIpAddr].isAlive) {\n                    countAlive++;\n                }\n            }\n            let areAllAlive = false;\n            if (countAll > 0 && countAll === countAlive) areAllAlive = true;\n            this.setStateChanged('info.connection', { val: areAllAlive, ack: true });\n        } catch (e) {\n            this.log.error(this.err2Str(e));\n            return;\n        }\n    }\n\n    /**\n     * MQTT: once new device info packet is coming in\n     */\n    public async onMqttInfo(obj: { clientId: string; ip: string; topic: string; infoObj: { [k: string]: any } }): Promise<void> {\n        try {\n            // log\n            this.log.debug(`[MQTT]\uD83D\uDCE1 ${this.fullys[obj.ip].name} published info, topic: ${obj.topic}`);\n            //this.log.debug(`[MQTT] Client ${obj.ip} Publish Info: Details: ${JSON.stringify(obj.infoObj)}`);\n\n            // keep client id\n            if (!this.fullys[obj.ip].mqttClientId) this.fullys[obj.ip].mqttClientId = obj.clientId;\n\n            // Create info objects\n            if (!this.fullys[obj.ip].mqttInfoObjectsCreated) {\n                this.log.debug(`[MQTT] ${this.fullys[obj.ip].name}: Creating info objects (if not yet existing)`);\n                await this.createInfoObjects('mqtt', obj.infoObj, obj.ip);\n                this.fullys[obj.ip].mqttInfoObjectsCreated = true;\n            }\n\n            // Fill info objects\n            await this.setInfoStates('MQTT', obj.infoObj, obj.ip);\n        } catch (e) {\n            this.log.error(this.err2Str(e));\n            return;\n        }\n    }\n\n    /**\n     * MQTT: once new event packet is coming in\n     */\n    public async onMqttEvent(obj: { clientId: string; ip: string; topic: string; cmd: string }): Promise<void> {\n        try {\n            // log\n            this.log.debug(`[MQTT] \uD83D\uDCE1 ${this.fullys[obj.ip].name} published event, topic: ${obj.topic}, cmd: ${obj.cmd}`);\n\n            // keep client id\n            if (!this.fullys[obj.ip].mqttClientId) this.fullys[obj.ip].mqttClientId = obj.clientId;\n\n            /**\n             * Set Event State\n             */\n            const pthEvent = `${this.fullys[obj.ip].id}.Events.${obj.cmd}`;\n            if (!(await this.getObjectAsync(pthEvent))) {\n                this.log.info(`[MQTT] ${this.fullys[obj.ip].name}: Event ${obj.cmd} received but state ${pthEvent} does not exist, so we create it first`);\n                await this.setObjectNotExistsAsync(pthEvent, { type: 'state', common: { name: 'MQTT Event: ' + obj.cmd, type: 'boolean', role: 'switch', read: true, write: false }, native: {} });\n            }\n            this.setState(pthEvent, { val: true, ack: true });\n\n            /**\n             * Confirm Command state(s) with ack: true\n             */\n            const pthCmd = this.fullys[obj.ip].id + '.Commands';\n\n            // Check if it is a switch with MQTT commands connected\n            const idx = this.getIndexFromConf(CONST.cmdsSwitches, ['mqttOn', 'mqttOff'], obj.cmd);\n            if (idx !== -1) {\n                // We have a switch\n                const conf = CONST.cmdsSwitches[idx]; // the found line from config array\n                const onOrOffCmd = obj.cmd === conf.mqttOn ? true : false;\n                await this.setStateAsync(`${pthCmd}.${conf.id}`, { val: onOrOffCmd, ack: true });\n                await this.setStateAsync(`${pthCmd}.${conf.cmdOn}`, { val: onOrOffCmd, ack: true });\n                await this.setStateAsync(`${pthCmd}.${conf.cmdOff}`, { val: !onOrOffCmd, ack: true });\n            } else {\n                // No switch\n                const idx = this.getIndexFromConf(CONST.cmds, ['id'], obj.cmd);\n                if (idx !== -1 && CONST.cmds[idx].type === 'boolean') {\n                    // We have a button, so set it to true\n                    await this.setStateAsync(`${pthCmd}.${obj.cmd}`, { val: true, ack: true });\n                } else {\n                    this.log.silly(`[MQTT] ${this.fullys[obj.ip].name}: Event cmd ${obj.cmd} - no REST API command is existing, so skip confirmation with with ack:true`);\n                }\n            }\n        } catch (e) {\n            this.log.error(this.err2Str(e));\n            return;\n        }\n    }\n\n    /**\n     * Called once a subscribed state changes. Initialized by Class constructor.\n     * @param id - e.g. \"fully-mqtt.0.Tablet-Bathroom.Commands.screenSwitch\"\n     * @param stateObj - e.g. { val: true, ack: false, ts: 123456789, q: 0, lc: 123456789 }\n     */\n    private async iob_onStateChange(stateId: string, stateObj: ioBroker.State | null | undefined): Promise<void> {\n        try {\n            if (!stateObj) return; // state was deleted, we disregard...\n            if (stateObj.ack) return; // ignore ack:true\n            const idSplit = stateId.split('.');\n            const deviceId = idSplit[2]; // \"Tablet-Bathroom\"\n            const channel = idSplit[3]; // \"Commands\"\n            const cmd = idSplit[4]; // \"screenSwitch\"\n            const pth = deviceId + '.' + channel; // Tablet-Bathroom.Commands\n            /**\n             * Commands\n             */\n            if (channel === 'Commands') {\n                this.log.debug(`state ${stateId} changed: ${stateObj.val} (ack = ${stateObj.ack})`);\n                // Get device object\n                const fully = this.getFullyByKey('id', deviceId);\n                if (!fully) throw `Fully object for deviceId '${deviceId}' not found!`;\n\n                let cmdToSend: string | undefined = cmd; // Command to send to Fully\n                let switchConf: undefined | ICmds = undefined; // Config line of switch\n\n                /****************\n                 * Check if it is a switch state cmd, like 'screenSwitch'\n                 ****************/\n                const idxSw = this.getIndexFromConf(CONST.cmdsSwitches, ['id'], cmd);\n                if (idxSw !== -1) {\n                    // It is a switch\n                    switchConf = CONST.cmdsSwitches[idxSw]; // the found line from config array\n                    cmdToSend = stateObj.val ? switchConf.cmdOn : switchConf.cmdOff;\n                } else {\n                    // Not a switch.\n                    // If val is false, we disregard, since it is a button only\n                    if (!stateObj.val) return;\n                }\n                if (!cmdToSend) throw `onStateChange() - ${stateId}: fullyCmd could not be determined!`;\n\n                /**\n                 * Send Command\n                 */\n                const sendCommand = await this.restApi_inst.sendCmd(fully, cmdToSend, stateObj.val);\n                if (sendCommand) {\n                    this.log.info(`${fully.name}: ${cmd} successfully set to ${stateObj.val}`);\n                    /**\n                     * Confirm with ack:true\n                     */\n                    if (switchConf !== undefined) {\n                        // it is a switch\n                        const onOrOffCmdVal = cmd === switchConf.cmdOn ? true : false;\n                        await this.setStateAsync(`${pth}.${switchConf.id}`, { val: onOrOffCmdVal, ack: true });\n                        await this.setStateAsync(`${pth}.${switchConf.cmdOn}`, { val: onOrOffCmdVal, ack: true });\n                        await this.setStateAsync(`${pth}.${switchConf.cmdOff}`, { val: !onOrOffCmdVal, ack: true });\n                    } else {\n                        // No switch\n                        if (typeof stateObj.val === 'boolean') {\n                            const idx = this.getIndexFromConf(CONST.cmds, ['id'], cmd);\n                            if (idx !== -1) {\n                                if (CONST.cmds[idx].type === 'boolean') {\n                                    // Is a button\n                                    await this.setStateAsync(stateId, { val: true, ack: true });\n                                } else {\n                                    // This should actually not happen, as we just define buttons in commands, but anyway\n                                    this.log.warn(`${fully.name}: ${stateId} - val: ${stateObj.val} is boolean, but cmd ${cmd} is not defined in CONF`);\n                                    await this.setStateAsync(stateId, { val: stateObj.val, ack: true });\n                                }\n                            } else {\n                                this.log.warn(`${fully.name}: ${stateId} - val: ${stateObj.val}, cmd ${cmd} is not defined in CONF`);\n                            }\n                        } else {\n                            // Non-boolean, so just set val with ack:true...\n                            await this.setStateAsync(stateId, { val: stateObj.val, ack: true });\n                        }\n                    }\n                } else {\n                    // log, more log lines were already published by this.restApi_inst.sendCmd()\n                    this.log.debug(`${fully.name}: restApiSendCmd() was not successful (${stateId})`);\n                }\n            }\n        } catch (e) {\n            this.log.error(this.err2Str(e));\n            return;\n        }\n    }\n\n    /**\n     * Get Fully Object per provided key and value\n     *   {\n     *     '192.168.10.20': {name: 'Tablet Kitchen', id:'Tablet-Kitchen', ip:'192.168.10.20', ...},\n     *     '192.168.10.30': {name: 'Tablet Hallway', id:'Tablet-Hallway', ip:'192.168.10.30', ...},\n     *   }\n     *   getFullyByKey('id', 'Tablet-Hallway') will return the second object...\n     * @param keyId - e.g. 'id', 'name', ...\n     * @param value - e.g. 'Tablet Hallway', ...\n     * @returns - fully object or false if not found\n     */\n    private getFullyByKey(keyId: string, value: any): IDevice | false {\n        for (const ip in this.fullys) {\n            if (keyId in this.fullys[ip]) {\n                const lpKeyId = keyId as string;\n                // Wow, what a line. Due to: https://bobbyhadz.com/blog/typescript-element-implicitly-has-any-type-expression\n                const lpVal = this.fullys[ip][lpKeyId as keyof (typeof this.fullys)[typeof ip]];\n                if (lpVal === value) {\n                    return this.fullys[ip];\n                }\n            }\n        }\n        return false;\n    }\n\n    /**\n     * Gets Index for given keys and a value\n     * @param config - config like CONST.cmds\n     * @param keys - like ['mqttOn','mqttOff']\n     * @param cmd - like 'onScreensaverStart'\n     * @returns Index (0-...), or -1 if not found\n     */\n    private getIndexFromConf(config: { [k: string]: any }[], keys: string[], cmd: string): number {\n        try {\n            let index = -1;\n            for (const key of keys) {\n                // Get array index\n                index = config.findIndex((x: { [k: string]: any }) => x[key] === cmd);\n                if (index !== -1) break;\n            }\n            return index;\n        } catch (e) {\n            this.log.error(this.err2Str(e));\n            return -1;\n        }\n    }\n\n    /**\n     * Is called when adapter shuts down - callback has to be called under any circumstances!\n     */\n    private iob_onUnload(callback: () => void): void {\n        try {\n            if (this.fullys) {\n                for (const ip in this.fullys) {\n                    // Clear Request Info timeout\n                    // @ts-expect-error \"Type 'null' is not assignable to type 'Timeout'.ts(2345)\" - we check for not being null via \"if\"\n                    if (this.fullys[ip].timeoutRestRequestInfo) this.clearTimeout(this.fullys[ip].timeoutRestRequestInfo);\n                    this.log.info(`${this.fullys[ip].name}: Clear timeouts.`);\n                    // Set alive status to false\n                    this.setState(this.fullys[ip].id + '.alive', { val: false, ack: true });\n                }\n            }\n\n            // Clear MQTT server timeouts\n            if (this.mqtt_Server) {\n                for (const clientId in this.mqtt_Server.devices) {\n                    // @ts-expect-error \"Type 'null' is not assignable to type 'Timeout'.ts(2345)\" - we check for not being null via \"if\"\n                    if (this.mqtt_Server.devices[clientId].timeoutNoUpdate) this.clearTimeout(this.mqtt_Server.devices[clientId].timeoutNoUpdate);\n                }\n            }\n\n            // destroy MQTT Server\n            if (this.mqtt_Server) {\n                this.mqtt_Server.terminate();\n            }\n\n            callback();\n        } catch (e) {\n            callback();\n        }\n    }\n}\n\nif (require.main !== module) {\n    // Export the constructor in compact mode\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new FullyMqtt(options);\n} else {\n    // otherwise start the instance directly\n    (() => new FullyMqtt())();\n}\n"],
  "mappings": "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",
  "names": ["idx"]
}
